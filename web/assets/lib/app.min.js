var overwatchApp=angular.module("overwatch",["ngRoute","angularModalService","ngIdle"]);overwatchApp.run(["$rootScope","$location","$routeParams",function(e,t,r){e.$on("$routeChangeSuccess",function(r,o,n){e.currentPage=t.path()})}]),overwatchApp.config(["$routeProvider","$httpProvider","IdleProvider",function(e,t,r){e.when("/",{title:"Dashboard",templateUrl:"partials/dashboard.html",controller:"DashboardController"}).when("/group/:id",{title:"Edit Group",templateUrl:"partials/editGroup.html",controller:"EditGroupController"}).when("/group/:id/add-test",{title:"Add test",templateUrl:"partials/testForm.html",controller:"AddTestController"}).when("/test/:id",{title:"View test",templateUrl:"partials/viewTest.html",controller:"ViewTestController"}).when("/test/:id/edit",{title:"Edit test",templateUrl:"partials/testForm.html",controller:"EditTestController"}).when("/users",{title:"Manage Users",templateUrl:"partials/manageUsers.html",controller:"ManageUsersController"}).when("/alerts",{title:"Change Alert Settings",templateUrl:"partials/changeAlertSettings.html",controller:"ManageAlertSettingsController"}).when("/my-account",{title:"My Account",templateUrl:"/profile/change-password",controller:"MyAccountController"}).when("/error",{title:"Error",templateUrl:"partials/error.html",controller:function(e,t){t.status={code:"500",text:"Internal Server Error"},e(!1)}}).otherwise({title:"Not Found",templateUrl:"partials/error.html",controller:function(e,t){t.status={code:"404",text:"Not Found"},e(!1)}}),t.interceptors.push("overwatchApiErrorHandler"),r.idle(300),r.timeout(5)}]),overwatchApp.controller("DashboardController",["showLoading","isGranted","$scope","overwatchApi","$window","$location","$interval",function(e,t,r,o,n,s,a){r.groups=[];var u=function(){o.get(Routing.generate("overwatch_test_testgroupapi_getallgroups")).success(function(t){r.groups=t,e(!1)})},i=a(u,6e4);r.$on("$destroy",function(){a.cancel(i)}),r.isGranted=function(e,r){return"undefined"==typeof r?t(e):t(e,r.name)},r.shouldWarnOfTestAge=function(){var e,t={total:0,count:0};return angular.forEach(r.groups,function(e){angular.forEach(e.tests,function(e){null!==e.result&&"undefined"!=typeof e.result.createdAt&&(this.total+=e.result.createdAt,this.count++)},this)},t),0===t.count?!1:(e=Date.now()/1e3-t.total/t.count,e>21600)},r.removeTest=function(t){n.confirm("Are you sure you want to remove this test? All historical data for this test will also be deleted.")&&(e(!0),o["delete"](Routing.generate("overwatch_test_testapi_deletetest",{id:t})).success(function(){u()}))},r.removeGroup=function(t){n.confirm("Are you sure you want to remove this group?")&&(e(!0),o["delete"](Routing.generate("overwatch_test_testgroupapi_deletegroup",{id:t})).success(function(){u()}))},r.createGroup=function(){var t=n.prompt("Please enter a name for the new group","Untitled Group");null!==t&&(e(!0),o.post(Routing.generate("overwatch_test_testgroupapi_creategroup"),{name:t}).success(function(){u()}))},r.runTest=function(t){e(!0),o.post(Routing.generate("overwatch_test_testapi_runtest",{id:t}),null).success(function(){s.path("/test/"+t)})},u()}]),overwatchApp.controller("EditGroupController",["showLoading","$scope","overwatchApi","$routeParams","$location","$window",function(e,t,r,o,n,s){t.group={};var a=function(){r.get(Routing.generate("overwatch_test_testgroupapi_getgroup",{id:o.id})).success(function(r){t.group=r,e(!1)})};t.removeUser=function(o){s.confirm("Are you sure you want to remove this user from group '"+t.group.name+"'?")&&(e(!0),r["delete"](Routing.generate("overwatch_test_testgroupapi_removeuserfromgroup",{groupId:t.group.id,userId:o})).success(function(){a()}))},t.addUser=function(){var o=s.prompt("Please enter the e-mail address of the user you wish to add to group '"+t.group.name+"'",currentUser.email);null!==o&&(e(!0),r.get(Routing.generate("overwatch_user_api_finduser",{email:o})).success(function(e){r.post(Routing.generate("overwatch_test_testgroupapi_addusertogroup",{groupId:t.group.id,userId:e.id}),{}).success(function(){a()})}).error(function(){e(!1),s.alert("Could not find user by e-mail address '"+o+"'. Please ensure that they are already registered.")}))},t.renameGroup=function(){var o=s.prompt("Please type a new name for this group",t.group.name);null!==o&&o!==t.group.name&&(e(!0),r.put(Routing.generate("overwatch_test_testgroupapi_updategroup",{id:t.group.id}),{name:o}).success(function(r){t.group=r,currentUser.groups.push(r.name),e(!1)}))},a()}]),overwatchApp.controller("AddTestController",["showLoading","$scope","overwatchApi","$routeParams","$location",function(e,t,r,o,n){t.title="Add test",t.test={},t.expectations=[],r.get(Routing.generate("overwatch_expectation_api_getall")).success(function(r){t.expectations=r,e(!1)}),t.save=function(){e(!0),r.post(Routing.generate("overwatch_test_testapi_createtest",{id:o.id}),t.test).success(function(){n.path("/")})}}]),overwatchApp.controller("ViewTestController",["showLoading","isGranted","$scope","overwatchApi","$routeParams","$interval","$location","$window","$q",function(e,t,r,o,n,s,a,u,i){r.test={},r.test.results={},r.lastRequestedResultSize=0,r.loadResults=function(t){var s=o.get(Routing.generate("overwatch_test_testapi_gettest",{id:n.id})).success(function(e){var t=r.test.results;r.test=e,r.test.results=t}),a=o.get(Routing.generate("overwatch_result_api_getresultsfortest",{id:n.id})+"?pageSize="+t).success(function(e){r.test.results=e,r.lastRequestedResultSize=t});i.all([s,a]).then(function(){e(!1)})},r.loadOlderResults=function(){e(!0),r.loadResults(r.lastRequestedResultSize+10)},r.removeTest=function(t){u.confirm("Are you sure you want to remove this test? All historical data for this test will also be deleted.")&&(e(!0),o["delete"](Routing.generate("overwatch_test_testapi_deletetest",{id:t})).success(function(){a.path("/")}))},r.isGranted=function(e,r){return"undefined"==typeof r?t(e):t(e,r.name)},r.runTest=function(t){e(!0),o.post(Routing.generate("overwatch_test_testapi_runtest",{id:t}),null).success(function(){r.loadResults(r.lastRequestedResultSize)})},r.loadResults(10);var c=s(function(){r.loadResults(r.lastRequestedResultSize)},6e4);r.$on("$destroy",function(){s.cancel(c)})}]),overwatchApp.controller("EditTestController",["showLoading","$scope","overwatchApi","$routeParams","$location","$q",function(e,t,r,o,n,s){t.title="Edit test",t.test={},t.expectations=[];var a=r.get(Routing.generate("overwatch_expectation_api_getall")).success(function(e){t.expectations=e}),u=r.get(Routing.generate("overwatch_test_testapi_gettest",{id:o.id})).success(function(e){t.test=e});s.all([a,u]).then(function(){e(!1)}),t.save=function(){e(!0),r.put(Routing.generate("overwatch_test_testapi_updatetest",{id:o.id}),t.test).success(function(){n.path("/test/"+o.id)})}}]),overwatchApp.controller("ManageUsersController",["showLoading","$scope","overwatchApi","$window","ModalService",function(e,t,r,o,n){t.users=[],t.updatedRoles=[],t.currentUserId=currentUser.id;var s=function(){r.get(Routing.generate("overwatch_user_api_getallusers")).success(function(r){t.users=r,e(!1)})};t.createUser=function(){var t=o.prompt("Please type the new user's email address.","");null!==t&&(e(!0),r.post(Routing.generate("overwatch_user_api_createuser",{email:t}),{}).success(function(e){s()}))},t.updateRole=function(t){n.showModal({templateUrl:"/partials/roleDialog.html",controller:"RoleDialogController"}).then(function(o){o.close.then(function(o){"CANCEL"!==o&&(e(!0),r.put(Routing.generate("overwatch_user_api_setuserrole",{id:t,role:o}),{}).success(function(){s()}))})})},t.lockUser=function(t){e(!0),r.put(Routing.generate("overwatch_user_api_togglelockuser",{id:t}),{}).success(function(){s()})},t.removeUser=function(t){o.confirm("Are you sure you want to permanently remove this user?")&&(e(!0),r["delete"](Routing.generate("overwatch_user_api_deleteuser",{id:t})).success(function(){s()}))},s()}]),overwatchApp.controller("ManageAlertSettingsController",["showLoading","$scope","overwatchApi",function(e,t,r){t.settings=[];var o=function(){r.get(Routing.generate("overwatch_user_api_getalertsettings")).success(function(r){t.settings=r,e(!1)})};t.isUsersSetting=function(e){return currentUser.alertSetting===e},t.saveSetting=function(t){e(!0),r.put(Routing.generate("overwatch_user_api_updateuser"),{alertSetting:t}).success(function(){currentUser.alertSetting=t,e(!1)})},o()}]),overwatchApp.controller("RoleDialogController",["$scope","close",function(e,t){e.close=function(e){t(e)}}]),overwatchApp.controller("MyAccountController",["showLoading","$scope","overwatchApi",function(e,t,r){t.telephoneNumber=currentUser.telephoneNumber,t.apiKeyFieldType="password",t.saveProfile=function(){e(!0),r.put(Routing.generate("overwatch_user_api_updateuser"),{telephoneNumber:t.telephoneNumber}).then(function(t){currentUser.telephoneNumber=t.data.telephoneNumber,e(!1)})["catch"](function(){e(!1),alert("Sorry, there was an error saving your telephone number.")})},t.toggleAPIKeyVisibility=function(){var e="password";"password"===t.apiKeyFieldType&&(e="text"),t.apiKeyFieldType=e},e(!1)}]),overwatchApp.run(["showLoading","$rootScope","$window","Idle",function(e,t,r,o){t.$on("$routeChangeStart",function(){e(!0)}),t.$on("$routeChangeSuccess",function(e,t){t.title?r.document.title=t.title+" - Overwatch":r.document.title="Overwatch"}),t.$on("IdleTimeout",function(){r.location.href="/logout"}),o.watch()}]),overwatchApp.factory("showLoading",["$rootScope",function(e){return function(t){e.isLoading=t}}]),overwatchApp.factory("isGranted",[function(){var e=function(t){return"ROLE_SUPER_ADMIN"!==t&&e("ROLE_SUPER_ADMIN")?!0:-1!==currentUser.roles.indexOf(t)},t=function(t){return e("ROLE_SUPER_ADMIN")?!0:-1!==currentUser.groups.indexOf(t)};return function(r,o){switch(r){case"SUPER_ADMIN":return e("ROLE_SUPER_ADMIN");case"ADMIN":return e("ROLE_ADMIN")&&t(o);case"USER":return t(o);default:return!1}}}]),overwatchApp.factory("overwatchApiAuth",[function(){return{getHttpHeaders:function(){return{"X-Api-User":this.getUser(),"X-Api-Timestamp":this.getTimestamp(),"X-Api-Token":this.getToken()}},getToken:function(){return CryptoJS.HmacSHA256("timestamp="+this.getTimestamp(),currentUser.apiKey)},getUser:function(){return currentUser.id},getTimestamp:function(){return(new Date).getTime().toString().substr(0,10)}}}]),overwatchApp.service("overwatchApi",["overwatchApiAuth","$http",function(e,t){return{call:function(r){return r.hasOwnProperty("headers")?r.headers=angular.merge(r.headers,e.getHttpHeaders()):r.headers=e.getHttpHeaders(),t(r)},transformUrl:function(e){return 0!==e.indexOf("/api/")&&(e=Routing.generate(e)),e},get:function(e){return this.call({method:"GET",url:this.transformUrl(e)})},post:function(e,t){return this.call({method:"POST",data:t,url:this.transformUrl(e)})},put:function(e,t){return this.call({method:"PUT",data:t,url:this.transformUrl(e)})},"delete":function(e){return this.call({method:"DELETE",url:this.transformUrl(e)})}}}]),overwatchApp.factory("overwatchApiErrorHandler",["$location","$window",function(e,t){return{responseError:function(r){401===r.status||403===r.status?t.location.reload():e.url("/error")}}}]),overwatchApp.filter("ucfirst",[function(){return function(e,t){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}}]),overwatchApp.filter("strLimit",["$filter",function(e){return function(t,r){return t.length<=r?t:e("limitTo")(t,r)+"..."}}]),overwatchApp.filter("timeago",[function(){return function(e,t){var e=1e3*e;if(isNaN(e))return"never";var r,o=function(e,t,r){var o="function"==typeof e?e(t,i):e,n=r.numbers&&r.numbers[t]||t;return o.replace(/%d/i,n)},n=(new Date).getTime(),s=new Date(e).getTime(),a=t||!1,u={prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years"},i=n-s,c=Math.abs(i)/1e3,l=c/60,p=l/60,d=p/24,h=d/365,f=void 0===u.wordSeparator?" ":u.wordSeparator,g=u.prefixAgo,m=u.suffixAgo;return a&&0>i&&(g=u.prefixFromNow,m=u.suffixFromNow),r=45>c&&o(u.seconds,Math.round(c),u)||90>c&&o(u.minute,1,u)||45>l&&o(u.minutes,Math.round(l),u)||90>l&&o(u.hour,1,u)||24>p&&o(u.hours,Math.round(p),u)||42>p&&o(u.day,1,u)||30>d&&o(u.days,Math.round(d),u)||45>d&&o(u.month,1,u)||365>d&&o(u.months,Math.round(d/30),u)||1.5>h&&o(u.year,1,u)||o(u.years,Math.round(h),u),[g,r,m].join(f).trim()}}]),!function(){"use strict";var e=angular.module("angularModalService",[]);e.factory("ModalService",["$document","$compile","$controller","$http","$rootScope","$q","$timeout","$templateCache",function(e,t,r,o,n,s,a,u){function i(){var e=this,i=function(e,t){var r=s.defer();if(e)r.resolve(e);else if(t){var n=u.get(t);void 0!==n?r.resolve(n):o({method:"GET",url:t,cache:!0}).then(function(e){u.put(t,e.data),r.resolve(e.data)})["catch"](function(e){r.reject(e)})}else r.reject("No template or templateUrl has been specified.");return r.promise};e.showModal=function(e){var o=s.defer(),u=e.controller;return u?(i(e.template,e.templateUrl).then(function(i){var l=n.$new(),p=s.defer(),d={$scope:l,close:function(e,t){(void 0===t||null===t)&&(t=0),a(function(){p.resolve(e)},t)}};if(e.inputs)for(var h in e.inputs)d[h]=e.inputs[h];var f=angular.element(i),g=t(f),m=g(l);d.$element=m;var w=r(u,d);e.appendElement?e.appendElement.append(m):c.append(m);var v={controller:w,scope:l,element:m,close:p.promise};v.close.then(function(){l.$destroy(),m.remove()}),o.resolve(v)})["catch"](function(e){o.reject(e)}),o.promise):(o.reject("No controller has been specified."),o.promise)}}var c=e.find("body");return new i}])}();